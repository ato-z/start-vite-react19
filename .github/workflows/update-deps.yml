name: Update Dependencies

on:
  # æ¯å‘¨ä¸€ä¸Šåˆ 9 ç‚¹è¿è¡Œ
  schedule:
    - cron: '0 9 * * 1'
  # åŒæ—¶æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# è®¾ç½®æƒé™
permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # 2. è®¾ç½® Node.js
      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. å¯ç”¨ Yarnï¼ˆé¡¹ç›®ä½¿ç”¨ yarnï¼‰
      - name: å¯ç”¨ Yarn
        run: |
          corepack enable
          corepack prepare yarn@stable --activate
          yarn --version

      # 4. å®‰è£…ä¾èµ–ï¼ˆç¡®ä¿ lockfile åŒæ­¥ï¼‰
      - name: å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ“¦ å®‰è£…ç°æœ‰ä¾èµ–..."
          yarn install --no-immutable

      # 5. æ›´æ–°ä¾èµ–ï¼ˆä»…å°ç‰ˆæœ¬å’Œè¡¥ä¸ç‰ˆæœ¬ï¼‰
      - name: æ£€æŸ¥å¯æ›´æ–°çš„ä¾èµ–
        id: check_updates
        run: |
          echo "ğŸ” æ£€æŸ¥ä¾èµ–æ›´æ–°..."

          # ä¿å­˜å½“å‰ yarn.lock çš„å“ˆå¸Œå€¼
          OLD_HASH=$(md5sum yarn.lock | awk '{print $1}')
          echo "å½“å‰ yarn.lock å“ˆå¸Œ: $OLD_HASH"

          # ä½¿ç”¨ yarn æ›´æ–°ä¾èµ–ï¼ˆä¿ç•™ package.json çš„ç‰ˆæœ¬èŒƒå›´ï¼‰
          yarn up '*'

          # æ£€æŸ¥ yarn.lock æ˜¯å¦å‘ç”Ÿå˜åŒ–
          NEW_HASH=$(md5sum yarn.lock | awk '{print $1}')
          echo "æ›´æ–°å yarn.lock å“ˆå¸Œ: $NEW_HASH"

          echo "ğŸ“„ æ£€æŸ¥æ–‡ä»¶å·®å¼‚..."
          git diff --stat

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
          if [ "$OLD_HASH" = "$NEW_HASH" ] && git diff --exit-code package.json; then
            echo "âœ… æ²¡æœ‰æ‰¾åˆ°å¯æ›´æ–°çš„ä¾èµ–"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ‰ å‘ç°ä¾èµ–æ›´æ–°"
            echo "has_updates=true" >> $GITHUB_OUTPUT

            # æ˜¾ç¤ºå…·ä½“æ›´æ–°äº†å“ªäº›åŒ…
            echo "ğŸ“‹ æ›´æ–°è¯¦æƒ…:"
            git diff package.json || true
          fi

      # 6. ç”Ÿæˆåˆ†æ”¯å
      - name: ç”Ÿæˆåˆ†æ”¯å
        if: steps.check_updates.outputs.has_updates == 'true'
        id: generate_branch
        run: |
          BRANCH_NAME="deps/update-$(date +%Y%m%d-%H%M%S)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "ğŸŒ¿ ç”Ÿæˆçš„åˆ†æ”¯å: $BRANCH_NAME"

      - name: æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          # ç§»é™¤ yarn çš„å®‰è£…çŠ¶æ€ç¼“å­˜æ–‡ä»¶ï¼Œä¸éœ€è¦æäº¤
          rm -f .yarn/install-state.gz

      # 7. åˆ›å»º Pull Request
      # ä½¿ç”¨ peter-evans/create-pull-request è‡ªåŠ¨åˆ›å»ºåˆ†æ”¯å’Œ PR
      - name: åˆ›å»º Pull Request
        if: steps.check_updates.outputs.has_updates == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.generate_branch.outputs.branch_name }}
          base: main # ç›®æ ‡åˆ†æ”¯
          title: 'chore: æ›´æ–°ä¾èµ–åŒ…'
          body: |
            ## ğŸ“¦ ä¾èµ–æ›´æ–°

            è‡ªåŠ¨æ£€æµ‹å¹¶æ›´æ–°äº† npm ä¾èµ–åŒ…çš„å°ç‰ˆæœ¬æ›´æ–°ã€‚

            ### æ›´æ”¹å†…å®¹
            - æ›´æ–°äº† `package.json` å’Œ `yarn.lock`
            - ä»…åŒ…å«å°ç‰ˆæœ¬ï¼ˆminorï¼‰å’Œè¡¥ä¸ï¼ˆpatchï¼‰æ›´æ–°

            ### æ£€æŸ¥æ¸…å•
            - [ ] ä»£ç å·²é€šè¿‡æœ¬åœ°æµ‹è¯•
            - [ ] æ›´æ–°æ—¥å¿—å·²æ›´æ–°ï¼ˆå¦‚éœ€è¦ï¼‰

            @${{ github.actor }} è¯· review å¹¶åˆå¹¶æ­¤ PR
          labels: |
            dependencies
            automated
          draft: false
          commit-message: 'chore: æ›´æ–°ä¾èµ–åˆ°æœ€æ–°å°ç‰ˆæœ¬'
          # ä¸åˆ é™¤åˆ†æ”¯ï¼Œä¾¿äºæŸ¥çœ‹å†å²
          delete-branch: false

      # 8. [æ–°å¢] è‡ªåŠ¨åˆå¹¶ PR
      - name: è‡ªåŠ¨åˆå¹¶ PR
        # åªæœ‰å½“ä¸Šä¸€æ­¥ç¡®å®åˆ›å»ºäº† PR æ—¶æ‰è¿è¡Œ
        if: steps.cpr.outputs.pull-request-number != ''
        run: |
          # --merge: ä½¿ç”¨åˆå¹¶æäº¤ (ä¹Ÿå¯ä»¥æ¢æˆ --squash æˆ– --rebase)
          # --auto:  å¦‚æœé…ç½®äº†åˆ†æ”¯ä¿æŠ¤è§„åˆ™ï¼ˆå¦‚éœ€è¦ CI é€šè¿‡ï¼‰ï¼Œå®ƒä¼šç­‰å¾…æ£€æŸ¥é€šè¿‡åè‡ªåŠ¨åˆå¹¶
          # --delete-branch: åˆå¹¶ååˆ é™¤ä¸´æ—¶åˆ†æ”¯
          gh pr merge ${{ steps.cpr.outputs.pull-request-number }} --merge --auto --delete-branch
        env:
          # ä½¿ç”¨ GitHub CLI éœ€è¦ GITHUB_TOKEN
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
